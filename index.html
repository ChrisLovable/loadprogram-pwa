<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Load Approval PWA</title>
    <meta name="theme-color" content="#059669" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <!-- Prevent aggressive caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New content is available, reload the page
                  window.location.reload();
                }
              });
            });
          });
        });
      }
      
      // Enhanced PWA Installation
      let deferredPrompt;
      let installButtonVisible = false;
      
      window.addEventListener('beforeinstallprompt', (e) => {
        // Don't prevent default - let browser show its own install banner
        deferredPrompt = e;
        installButtonVisible = true;
        
        // Show custom install button as alternative
        showInstallButton();
      });
      
      function showInstallButton() {
        // Only show if browser doesn't show its own install banner
        setTimeout(() => {
          if (installButtonVisible && deferredPrompt) {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = 'ðŸ“± Install App';
            installBtn.style.cssText = `
              position: fixed;
              bottom: 20px;
              right: 20px;
              z-index: 10000;
              background: linear-gradient(135deg, #059669 0%, #047857 100%);
              color: white;
              border: none;
              padding: 10px 16px;
              border-radius: 12px;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
              transition: all 0.2s ease;
            `;
            
            installBtn.onclick = () => showInstallPrompt();
            installBtn.onmouseover = () => {
              installBtn.style.transform = 'translateY(-2px)';
              installBtn.style.boxShadow = '0 6px 16px rgba(5, 150, 105, 0.4)';
            };
            installBtn.onmouseout = () => {
              installBtn.style.transform = 'translateY(0)';
              installBtn.style.boxShadow = '0 4px 12px rgba(5, 150, 105, 0.3)';
            };
            
            document.body.appendChild(installBtn);
          }
        }, 2000); // Wait 2 seconds to see if browser shows its own banner
      }
      
      function showInstallPrompt() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the install prompt');
              // Hide install button
              const installBtn = document.querySelector('button[style*="position: fixed"]');
              if (installBtn) installBtn.remove();
              installButtonVisible = false;
            }
            deferredPrompt = null;
          });
        }
      }
      
      // Hide install button if app is already installed
      window.addEventListener('appinstalled', () => {
        console.log('PWA was installed');
        const installBtn = document.querySelector('button[style*="position: fixed"]');
        if (installBtn) installBtn.remove();
        installButtonVisible = false;
      });
      
      // Make function globally available
      window.showInstallPrompt = showInstallPrompt;
    </script>
  </body>
</html>
